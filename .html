<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç´”JSé›¢ç·šç‰ˆï¼šç’°å¢ƒäº®åº¦åˆ¤å®š</title>
    
    <style>
        /* ä¿æŒåŸæœ‰çš„å…¨å±é¢¨æ ¼ */
        body { 
            margin: 0; padding: 0; background-color: #000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            overflow: hidden; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh;
        }
        #cam-container { 
            position: relative; width: 100%; height: 100%; display: flex; 
            justify-content: center; align-items: center; background: #111; 
        }
        /* Video é¡åƒç¿»è½‰ */
        video { 
            position: absolute; width: 100%; height: 100%; object-fit: cover; 
            transform: scaleX(-1); 
        }
        /* Canvas ä¾ç„¶å­˜åœ¨ï¼Œä½†ç”¨æ–¼è¨ˆç®—åƒç´ äº®åº¦ */
        #canvas { display: none; } 

        /* ä»‹é¢è¦†è“‹å±¤ */
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none; display: flex; flex-direction: column; 
            justify-content: space-between; padding: 20px; box-sizing: border-box; 
        }
        .status-bar { 
            background: rgba(0, 0, 0, 0.6); color: #00ffcc; padding: 10px 15px; 
            border-radius: 20px; font-size: 14px; backdrop-filter: blur(5px); 
            align-self: flex-start; pointer-events: auto; margin-top: 10px; line-height: 1.6; 
        }
        
        /* çµæœé¡¯ç¤ºå€å¡Š */
        #result-display { 
            background: rgba(0, 0, 0, 0.7); color: white; padding: 20px; border-radius: 15px; 
            align-self: center; margin-bottom: 50px; width: 90%; max-width: 400px; 
            text-align: center; pointer-events: auto; 
        }
        #light-level { 
            font-size: 2.2em; font-weight: bold; color: #FFC107; margin-bottom: 10px; 
        }
        #activity-recommendation { 
            font-size: 1.2em; color: #B3E5FC; 
        }

        /* å•Ÿå‹•ç•«é¢ - ç°¡åŒ–ç‚ºæ¬Šé™æç¤º */
        #start-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.95); 
            z-index: 20; display: flex; 
            flex-direction: column; justify-content: center; align-items: center; 
            text-align: center; color: white; 
        }
        button { 
            background: #007aff; color: white; border: none; padding: 15px 40px; 
            font-size: 18px; border-radius: 30px; cursor: pointer; margin-top: 20px; 
            font-weight: bold; box-shadow: 0 4px 15px rgba(0,122,255,0.4); transition: transform 0.2s; 
        }
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; color: #888; cursor: not-allowed; box-shadow: none; }
    </style>
</head>
<body>

    <div id="cam-container">
        <video id="video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="ui-layer">
        <div class="status-bar" id="status">ç­‰å¾…ç›¸æ©Ÿå•Ÿå‹•...</div>
        
        <div id="result-display">
            <div id="light-level">ç­‰å¾…äº®åº¦åˆ¤å®š</div>
            <div id="activity-recommendation"></div>
        </div>
    </div>

    <div id="start-screen">
        <h2 id="loading-text">é›¢ç·šäº®åº¦åˆ¤å®šï¼šæº–å‚™å°±ç·’</h2>
        <p id="info-text" style="font-size: 0.9em; color: #aaa; margin: 0 20px;">
            æ­¤ç‰ˆæœ¬ä½¿ç”¨**ç´” JavaScript** è¨ˆç®—å…‰ç·šäº®åº¦ï¼Œ**ç„¡éœ€ç¶²è·¯**ï¼<br>
            è«‹é»æ“Šé–‹å§‹ï¼Œä¸¦å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚
        </p>
        <button id="btn-start">ğŸš€ é–‹å§‹åˆ¤å®š (å®Œå…¨é›¢ç·š)</button>
    </div>

    <script>
        // DOM å…ƒç´ 
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const btnStart = document.getElementById('btn-start');
        const statusText = document.getElementById('status');
        const startScreen = document.getElementById('start-screen');
        const loadingText = document.getElementById('loading-text');
        const infoText = document.getElementById('info-text');
        const lightLevelElement = document.getElementById('light-level');
        const recommendationElement = document.getElementById('activity-recommendation');

        // æ ¸å¿ƒåƒæ•¸
        let animationFrameId = null;
        
        // æ´»å‹•æ¨è–¦å­—å…¸ (æ ¹æ“šäº®åº¦é–¾å€¼ 0-255)
        const THRESHOLDS = {
            'æ˜äº®æˆ¶å¤–/é«˜å…‰': { min: 180, emoji: 'â˜€ï¸', recommend: 'æ…¢è·‘ã€é¨å–®è»Šã€æˆ¶å¤–é‡é¤', color: '#FFD700' },
            'å……è¶³å®¤å…§/ä¸­å…‰': { min: 80, emoji: 'ğŸ’¡', recommend: 'é–±è®€æ›¸ç±ã€è¦åŠƒæ¸…å–®ã€å­¸ç¿’æ–°æŠ€èƒ½', color: '#00ffcc' },
            'æ˜æš—å¤œæ™š/ä½å…‰': { min: 0, emoji: 'ğŸŒ™', recommend: 'å†¥æƒ³æ”¾é¬†ã€è½è¼•éŸ³æ¨‚ã€æº–å‚™å°±å¯¢', color: '#8A2BE2' }
        };

        // 1. åˆå§‹åŒ–
        window.onload = () => {
            btnStart.addEventListener('click', startProcess);
        }

        async function startProcess() {
            startScreen.style.display = 'none';
            statusText.textContent = 'ğŸš€ å˜—è©¦å•Ÿå‹•ç›¸æ©Ÿ...';
            
            const cameraSuccess = await setupCamera();
            if (cameraSuccess) {
                statusText.textContent = 'âœ… ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸï¼æ­£åœ¨è¨ˆç®—äº®åº¦ (å®Œå…¨é›¢ç·š)...';
                // é–‹å§‹ç´” JS å¾ªç’°
                analyzeBrightnessLoop();
            }
        }

        // 2. è¨­å®šç›¸æ©Ÿ (å„ªåŒ–å•Ÿå‹•ï¼Œé™ä½å¤±æ•—ç‡)
        async function setupCamera() {
            const constraints = {
                audio: false,
                video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
            };
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        window.addEventListener('resize', () => {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                        });
                        resolve(true);
                    };
                });
            } catch (e) {
                // å¦‚æœå‰ç½®é¡é ­å¤±æ•—ï¼Œå˜—è©¦å¾Œç½®
                try {
                    constraints.video.facingMode = 'environment';
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    return new Promise((resolve) => {
                        video.onloadedmetadata = () => {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            resolve(true);
                        };
                    });
                } catch (e2) {
                    // æœ€çµ‚å¤±æ•—æç¤º
                    loadingText.textContent = `âŒ ç›¸æ©Ÿæ¬Šé™è¢«æ‹’çµ•æˆ–ä¸æ”¯æŒï¼`;
                    infoText.innerHTML = `è«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨ç›¸æ©Ÿæ¬Šé™æ‰èƒ½é€²è¡Œåˆ¤å®šã€‚`;
                    startScreen.style.display = 'flex';
                    return false;
                }
            }
        }

        // 3. äº®åº¦åˆ†ææ ¸å¿ƒ (ç´” JS é›¢ç·šé‹ä½œ)
        function analyzeBrightnessLoop() {
            if (video.readyState < 2) {
                animationFrameId = requestAnimationFrame(analyzeBrightnessLoop);
                return;
            }

            // A. ç¹ªè£½è¦–è¨Šå¹€åˆ° Canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // B. è®€å– Canvas åƒç´ æ•¸æ“š
            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                let totalLuminosity = 0;
                let pixelCount = 0;

                // C. éæ­·åƒç´ ï¼Œè¨ˆç®—å¹³å‡äº®åº¦ (Luminosity)
                // åªå–éƒ¨åˆ†åƒç´ ä»¥æé«˜æ€§èƒ½
                const step = 4 * 10; // æ¯ 10 å€‹åƒç´ å–æ¨£ä¸€æ¬¡
                for (let i = 0; i < data.length; i += step) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // äº®åº¦å…¬å¼ (åŸºæ–¼ ITU-R BT.709)
                    const luminosity = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                    totalLuminosity += luminosity;
                    pixelCount++;
                }

                const averageLuminosity = totalLuminosity / pixelCount;
                
                // D. æ ¹æ“šå¹³å‡äº®åº¦é€²è¡Œåˆ¤å®š
                let result = { level: 'ç„¡æ³•åˆ¤æ–·', emoji: '?', recommend: 'è«‹ç§»å‹•åˆ°æœ‰å…‰ç·šçš„åœ°æ–¹', color: '#ccc' };

                if (averageLuminosity >= THRESHOLDS['æ˜äº®æˆ¶å¤–/é«˜å…‰'].min) {
                    result = THRESHOLDS['æ˜äº®æˆ¶å¤–/é«˜å…‰'];
                } else if (averageLuminosity >= THRESHOLDS['å……è¶³å®¤å…§/ä¸­å…‰'].min) {
                    result = THRESHOLDS['å……è¶³å®¤å…§/ä¸­å…‰'];
                } else {
                    result = THRESHOLDS['æ˜æš—å¤œæ™š/ä½å…‰'];
                }

                // E. æ›´æ–° UI
                updateUI(result, averageLuminosity);

            } catch (e) {
                statusText.textContent = `âŒ éŒ¯èª¤ï¼šç„¡æ³•è®€å– Canvas æ•¸æ“šã€‚`;
            }

            animationFrameId = requestAnimationFrame(analyzeBrightnessLoop);
        }

        // 4. æ›´æ–°ä»‹é¢
        function updateUI(result, avg) {
            lightLevelElement.textContent = `${result.emoji} ${result.level}`;
            lightLevelElement.style.color = result.color;
            
            recommendationElement.innerHTML = 
                `<strong>æ¨è–¦æ´»å‹•:</strong> ${result.recommend} 
                 <br><span style="font-size: 0.8em; opacity: 0.7;"> (å¹³å‡äº®åº¦: ${Math.round(avg)}/255) </span>`;
        }

        // 5. è³‡æºæ¸…ç†
        window.onbeforeunload = () => {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        };

    </script>
</body>
</html>
