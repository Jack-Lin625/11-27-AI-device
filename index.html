<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>On-Device AI å…‰ç·šåˆ¤æ–·</title>

    <!-- ä¸å†ä½¿ç”¨å¤–éƒ¨ CDNï¼Œå…¨éƒ¨ç”¨åŸç”Ÿ JSï¼Œåœ¨è£ç½®ä¸Šåšäº®åº¦æ¨¡å‹ -->

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* é˜²æ­¢æ²å‹• */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        /* è¦–è¨Šèˆ‡ç•«å¸ƒçš„å®¹å™¨ */
        #cam-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
        }

        /* å½±åƒèˆ‡ Canvas é‡ç–Š */
        video, canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover; /* è®“ç•«é¢å¡«æ»¿æ‰‹æ©Ÿè¢å¹• */
        }

        /* ä»‹é¢è¦†è“‹å±¤ (UI Overlay) */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°ä¸‹æ–¹ */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        /* ç‹€æ…‹åˆ— */
        .status-bar {
            background: rgba(0, 0, 0, 0.6);
            color: #00ffcc;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(5px);
            align-self: flex-start;
            pointer-events: auto;
        }

        /* ä¸‹æ–¹å¤§å»ºè­°å¡ç‰‡ */
        .suggestion-card {
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 14px 16px;
            border-radius: 16px;
            font-size: 14px;
            backdrop-filter: blur(8px);
            pointer-events: auto;
            max-width: 90%;
            margin-bottom: 8px;
        }

        .suggestion-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .suggestion-detail {
            font-size: 13px;
            color: #ddd;
        }

        .suggestion-light {
            font-size: 11px;
            color: #7dd3fc;
            margin-top: 4px;
        }

        /* å•Ÿå‹•æŒ‰éˆ• / è¼‰å…¥ç•«é¢ */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
        }

        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,122,255,0.4);
            transition: transform 0.2s;
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00ffcc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            display: none; /* é è¨­éš±è— */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .offline-tip {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 8px;
        }
    </style>
</head>
<body>

    <div id="cam-container">
        <video id="video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="ui-layer">
        <div class="status-bar" id="status">ç­‰å¾…å•Ÿå‹•...</div>

        <div class="suggestion-card">
            <div class="suggestion-title" id="suggest-title">å°šæœªåˆ†æå…‰ç·š</div>
            <div class="suggestion-detail" id="suggest-detail">
                æŒ‰ä¸‹ã€Œé–‹å§‹åµæ¸¬ã€ï¼ŒOOOOO æœƒè®€å–ç’°å¢ƒäº®åº¦ï¼Œå¹«ä½ åˆ¤æ–·ç¾åœ¨æ¯”è¼ƒé©åˆè®€æ›¸ã€ç©éŠæˆ²é‚„æ˜¯ç¡è¦ºã€‚
            </div>
            <div class="suggestion-light" id="suggest-light">å¹³å‡äº®åº¦ï¼šâ€”ï¼ˆ0 æš— ~ 255 äº®ï¼‰</div>
        </div>
    </div>

    <div id="start-screen">
        <div class="loader" id="loader"></div>
        <h2 id="loading-text">æº–å‚™å•Ÿå‹• On-Device äº®åº¦æ¨¡å‹</h2>
        <p style="font-size: 0.9em; color: #aaa; margin: 0 20px;">
            è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚<br>é é¢è¼‰å…¥å¾Œå¯é›¢ç·šä½¿ç”¨ï¼Œåªåœ¨ä½ çš„è£ç½®ä¸Šè¨ˆç®—äº®åº¦ã€‚
        </p>
        <button id="btn-start">é–‹å§‹åµæ¸¬å…‰ç·š</button>
        <div class="offline-tip">
            æç¤ºï¼šè¼‰å…¥å®Œæˆå¾Œï¼Œé—œæ‰ç¶²è·¯ / é–‹é£›èˆªæ¨¡å¼ä¹Ÿèƒ½ç¹¼çºŒç”¨ã€‚
        </div>
    </div>

    <script>
        // DOM å…ƒç´ 
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const btnStart = document.getElementById('btn-start');
        const statusText = document.getElementById('status');
        const startScreen = document.getElementById('start-screen');
        const loader = document.getElementById('loader');
        const loadingText = document.getElementById('loading-text');

        const suggestTitle = document.getElementById('suggest-title');
        const suggestDetail = document.getElementById('suggest-detail');
        const suggestLight = document.getElementById('suggest-light');

        let isRunning = false;

        // ç”¨ä¾†è¨ˆç®—äº®åº¦çš„ã€Œéš±è— canvasã€ï¼Œä¸åŠ åˆ° DOM è£¡
        const sampleCanvas = document.createElement('canvas');
        const sampleCtx = sampleCanvas.getContext('2d');

        // å•Ÿå‹•æŒ‰éˆ•äº‹ä»¶
        btnStart.addEventListener('click', async () => {
            btnStart.style.display = 'none';
            loader.style.display = 'block';
            loadingText.innerText = "æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿèˆ‡äº®åº¦å°æ¨¡å‹...";

            try {
                await initCamera();
                // æ¨¡å‹å…¶å¯¦åªæ˜¯ JS è¦å‰‡ï¼Œé€™é‚Šç•¶ä½œã€Œè¼‰å…¥å®Œæˆã€
                loadingText.innerText = "ç’°å¢ƒåˆå§‹åŒ–å®Œæˆï¼";

                // ä¸€é»é»å»¶é²è®“ä½¿ç”¨è€…çœ‹åˆ°æç¤º
                setTimeout(() => {
                    startScreen.style.display = 'none';
                    statusText.innerText = "On-Device äº®åº¦æ¨¡å‹é‹è¡Œä¸­";
                    resizeCanvas();
                    isRunning = true;
                    requestAnimationFrame(brightnessLoop);
                    window.addEventListener('resize', resizeCanvas);
                }, 500);
            } catch (error) {
                console.error(error);
                loadingText.innerText = "éŒ¯èª¤ï¼š" + error.message;
                loader.style.display = 'none';
                btnStart.style.display = 'inline-block';
                btnStart.innerText = "é‡è©¦";
            }
        });

        // è¨­å®šç›¸æ©Ÿ
        async function initCamera() {
            const constraints = {
                audio: false,
                video: {
                    facingMode: 'environment', // å„ªå…ˆç”¨å¾Œé¡é ­æ¸¬ç’°å¢ƒå…‰
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;

            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    resolve(video);
                };
            });
        }

        // Canvas å°ºå¯¸è·Ÿè‘— video åŸå§‹è§£æåº¦èµ°ï¼ŒCSS è² è²¬æ‹‰åˆ°å…¨è¢å¹•
        function resizeCanvas() {
            if (!video.videoWidth || !video.videoHeight) return;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        // è¨ˆç®—å¹³å‡äº®åº¦
        function computeAverageBrightness(imageData) {
            const data = imageData.data;
            let sum = 0;
            const step = 4 * 8; // é–“éš”å–æ¨£ï¼Œæ¸›å°‘é‹ç®—é‡
            let count = 0;

            for (let i = 0; i < data.length; i += step) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const brightness = (r + g + b) / 3;
                sum += brightness;
                count++;
            }
            return count ? sum / count : 0;
        }

        // æ ¹æ“šäº®åº¦çµ¦å»ºè­°ï¼šè®€æ›¸ / ç©éŠæˆ² / æ”¾é¬† / ç¡è¦º
        function suggestByBrightness(avgBrightness) {
            // 0 ~ 255
            let suggestion = {
                title: "äº®åº¦è³‡è¨Šä¸è¶³",
                detail: "å†è®“é¡é ­å¤šçœ‹ä¸€ä¸‹å‘¨åœç’°å¢ƒï¼Œæˆ–å¾®èª¿ä¸€ä¸‹æ‰‹æ©Ÿä½ç½®ã€‚",
                color: "rgba(148, 163, 184, 0.40)" // default ç°è‰²
            };

            if (avgBrightness >= 180) {
                suggestion.title = "è¶…é©åˆè®€æ›¸ / å°ˆå¿ƒå·¥ä½œ";
                suggestion.detail = "ç’°å¢ƒéå¸¸æ˜äº®ï¼Œæ³¨æ„è¢å¹•åˆ¥å¤ªåˆºçœ¼å°±å¾ˆé©åˆè®€æ›¸ã€å¯«ä½œæ¥­ã€å°ˆå¿ƒå¯«ç¨‹å¼ã€‚";
                suggestion.color = "rgba(74, 222, 128, 0.28)"; // ç¶ å…‰
            } else if (avgBrightness >= 130 && avgBrightness < 180) {
                suggestion.title = "å¾ˆé©åˆç©éŠæˆ² / çœ‹å½±ç‰‡";
                suggestion.detail = "å…‰ç·šåä¸­ç­‰ï¼Œè¢å¹•ä¸æœƒå¤ªäº®ä¹Ÿä¸æœƒå¤ªæš—ï¼Œå¾ˆé©åˆæ‰“éŠæˆ²ã€è¿½åŠ‡ã€é€› IGã€‚";
                suggestion.color = "rgba(56, 189, 248, 0.28)"; // è—å…‰
            } else if (avgBrightness >= 90 && avgBrightness < 130) {
                suggestion.title = "å¾®æš—ç’°å¢ƒ Â· æ¯”è¼ƒé©åˆæ”¾é¬†";
                suggestion.detail = "é€™ç¨®äº®åº¦è®€æ›¸å®¹æ˜“æƒ³ç¡ï¼Œå¯ä»¥ç•¶ä½œæ»‘æ‰‹æ©Ÿã€è½æ­Œã€è·Ÿæœ‹å‹èŠå¤©çš„ Chill æ¨¡å¼ã€‚";
                suggestion.color = "rgba(251, 191, 36, 0.28)"; // é»ƒå…‰
            } else if (avgBrightness >= 50 && avgBrightness < 90) {
                suggestion.title = "åæš— Â· å¾ˆé©åˆæº–å‚™ç¡è¦º";
                suggestion.detail = "äº®åº¦å·²ç¶“è »ä½äº†ï¼Œå¾ˆé©åˆæ”¶å·¥æº–å‚™ç¡è¦ºã€‚é•·æ™‚é–“ç›¯è¢å¹•æœƒæ›´å‚·çœ¼ã€‚";
                suggestion.color = "rgba(96, 165, 250, 0.30)"; // æ·±è—
            } else {
                suggestion.title = "å¹¾ä¹å…¨æš— Â· ç¡è¦ºæ™‚é–“åˆ°";
                suggestion.detail = "é€™å€‹äº®åº¦é‚„åœ¨æ»‘æ‰‹æ©ŸçœŸçš„è¶…å‚·çœ¼ï¼Œå»ºè­°æŠŠæ‰‹æ©Ÿæ”¾ä¸‹ï¼Œå¥½å¥½ç¡ä¸€è¦ºã€‚";
                suggestion.color = "rgba(15, 23, 42, 0.75)"; // æ·±é»‘è—
            }

            return suggestion;
        }

        // äº®åº¦åµæ¸¬ä¸» loop
        let lastUpdateTime = 0;
        function brightnessLoop(timestamp) {
            if (!isRunning) return;
            if (!video.videoWidth || !video.videoHeight) {
                requestAnimationFrame(brightnessLoop);
                return;
            }

            // æ¯ 200ms æ›´æ–°ä¸€æ¬¡å°±å¥½ï¼Œé¿å…å¤ªåƒæ•ˆèƒ½
            if (timestamp - lastUpdateTime > 200) {
                lastUpdateTime = timestamp;

                // æ¸…ç©º overlay canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // è¨­å®š sampleCanvas å°ºå¯¸
                const sampleWidth = 160;
                const sampleHeight = 120;
                sampleCanvas.width = sampleWidth;
                sampleCanvas.height = sampleHeight;

                // æŠŠ video ç•«åˆ°ã€Œéš±è— canvasã€
                sampleCtx.drawImage(video, 0, 0, sampleWidth, sampleHeight);

                const imageData = sampleCtx.getImageData(0, 0, sampleWidth, sampleHeight);
                const avgBrightness = computeAverageBrightness(imageData);

                // å–å¾—å»ºè­°
                const suggestion = suggestByBrightness(avgBrightness);

                // åœ¨ç•«é¢ä¸‹æ–¹åŠ ä¸€å±¤é€æ˜è‰²å¡Šç•¶æ°›åœå…‰
                ctx.fillStyle = suggestion.color;
                ctx.fillRect(0, canvas.height * 0.7, canvas.width, canvas.height * 0.3);

                // æ›´æ–° UI æ–‡æ¡ˆ
                suggestTitle.innerText = suggestion.title;
                suggestDetail.innerText = suggestion.detail;
                suggestLight.innerText = `å¹³å‡äº®åº¦ï¼šç´„ ${avgBrightness.toFixed(0)}ï¼ˆ0 æš— ~ 255 äº®ï¼‰`;

                // æ›´æ–°ç‹€æ…‹åˆ—
                let levelText = "åµæ¸¬åˆ°çš„å…‰ç·šç‹€æ…‹ï¼š";
                if (avgBrightness >= 180) levelText += "éå¸¸æ˜äº® âœ…";
                else if (avgBrightness >= 130) levelText += "ä¸­ç­‰åäº® âœ…";
                else if (avgBrightness >= 90) levelText += "åæš— ğŸŒ™";
                else levelText += "è¶…æš— ğŸŒ™";
                statusText.innerText = levelText + " Â· On-Device é‹ç®—ä¸­";
            }

            requestAnimationFrame(brightnessLoop);
        }
    </script>
</body>
</html>
