<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OOOOO Â· On-Device AI å…‰ç·šé¡§å•</title>

    <!-- ä¸ä½¿ç”¨å¤–éƒ¨ AI CDNï¼Œå…¨éƒ¨åœ¨æœ¬æ©Ÿç”¨ JS åšäº®åº¦å°æ¨¡å‹ -->

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* é˜²æ­¢æ²å‹• */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        /* è¦–è¨Šèˆ‡ç•«å¸ƒçš„å®¹å™¨ */
        #cam-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
        }

        /* å½±åƒèˆ‡ Canvas é‡ç–Š */
        video, canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover; /* è®“ç•«é¢å¡«æ»¿æ‰‹æ©Ÿè¢å¹• */
        }

        /* ä»‹é¢è¦†è“‹å±¤ (UI Overlay) */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°ä¸‹æ–¹ */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        /* ç‹€æ…‹åˆ— */
        .status-bar {
            background: rgba(0, 0, 0, 0.6);
            color: #00ffcc;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(5px);
            align-self: flex-start;
            pointer-events: auto;
        }

        /* ä¸‹æ–¹å»ºè­°å¡ç‰‡ */
        .suggestion-card {
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 14px 16px;
            border-radius: 16px;
            font-size: 14px;
            backdrop-filter: blur(8px);
            pointer-events: auto;
            max-width: 90%;
            margin-bottom: 8px;
        }

        .suggestion-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .suggestion-detail {
            font-size: 13px;
            color: #ddd;
        }

        .suggestion-light {
            font-size: 11px;
            color: #7dd3fc;
            margin-top: 4px;
        }

        /* å•Ÿå‹•æŒ‰éˆ• / è¼‰å…¥ç•«é¢ */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
        }

        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,122,255,0.4);
            transition: transform 0.2s;
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00ffcc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            display: none; /* é è¨­éš±è— */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .offline-tip {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 8px;
        }

        /* åµæ¸¬æ¡†æ¨£å¼ï¼ˆé€™è£¡ç”¨ä¾†åšä¸‹æ–¹è‰²å¡Šçš„é¢¨æ ¼ï¼‰ */
        .prediction-text {
            font-weight: bold;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div id="cam-container">
        <video id="video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="ui-layer">
        <div class="status-bar" id="status">ç­‰å¾…å•Ÿå‹•...</div>

        <div class="suggestion-card">
            <div class="suggestion-title" id="suggest-title">å°šæœªåˆ†æå…‰ç·š</div>
            <div class="suggestion-detail" id="suggest-detail">
                æŒ‰ä¸‹ã€Œé–‹å§‹åµæ¸¬å…‰ç·šã€ï¼ŒOOOOO æœƒè®€å–ç’°å¢ƒäº®åº¦ï¼Œå¹«ä½ åˆ¤æ–·ç¾åœ¨æ¯”è¼ƒé©åˆè®€æ›¸ã€ç©éŠæˆ²ã€æ”¾é¬†é‚„æ˜¯ç¡è¦ºã€‚
            </div>
            <div class="suggestion-light" id="suggest-light">å¹³å‡äº®åº¦ï¼šâ€”ï¼ˆ0 æš— ~ 255 äº®ï¼‰</div>
        </div>
    </div>

    <div id="start-screen">
        <div class="loader" id="loader"></div>
        <h2 id="loading-text">æº–å‚™å•Ÿå‹• On-Device å…‰ç·šæ¨¡å‹</h2>
        <p style="font-size: 0.9em; color: #aaa; margin: 0 20px;">
            è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚<br>æ¨¡å‹å•Ÿå‹•å¾Œï¼Œåªè¦é€™å€‹é é¢ä¸é—œé–‰ï¼Œå°±èƒ½åœ¨ç„¡ç¶²è·¯ / é£›èˆªæ¨¡å¼ä¸‹ç¹¼çºŒä½¿ç”¨ã€‚
        </p>
        <button id="btn-start">é–‹å§‹åµæ¸¬å…‰ç·š</button>
        <div class="offline-tip">
            æç¤ºï¼šé€™å€‹ Demo å…¨éƒ¨åœ¨ä½ çš„æ‰‹æ©Ÿç«¯é‹ç®—ï¼Œç•«é¢ä¸æœƒä¸Šå‚³ã€‚
        </div>
    </div>

    <script>
        // DOM å…ƒç´ 
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const btnStart = document.getElementById('btn-start');
        const statusText = document.getElementById('status');
        const startScreen = document.getElementById('start-screen');
        const loader = document.getElementById('loader');
        const loadingText = document.getElementById('loading-text');

        const suggestTitle = document.getElementById('suggest-title');
        const suggestDetail = document.getElementById('suggest-detail');
        const suggestLight = document.getElementById('suggest-light');

        let isRunning = false;

        // ç”¨ä¾†è¨ˆç®—äº®åº¦çš„éš±è— canvasï¼ˆä¸åŠ åˆ° DOMï¼‰
        const sampleCanvas = document.createElement('canvas');
        const sampleCtx = sampleCanvas.getContext('2d');

        // å•Ÿå‹•æŒ‰éˆ•äº‹ä»¶
        btnStart.addEventListener('click', async () => {
            btnStart.style.display = 'none';
            loader.style.display = 'block';
            loadingText.innerText = "æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿèˆ‡äº®åº¦å°æ¨¡å‹...";

            try {
                await initCamera();

                loadingText.innerText = "ç’°å¢ƒåˆå§‹åŒ–å®Œæˆï¼Œæº–å‚™é–‹å§‹åµæ¸¬å…‰ç·š";

                setTimeout(() => {
                    startScreen.style.display = 'none';
                    statusText.innerText = "On-Device äº®åº¦æ¨¡å‹é‹ä½œä¸­";
                    resizeCanvas();
                    isRunning = true;
                    requestAnimationFrame(brightnessLoop);
                    window.addEventListener('resize', resizeCanvas);
                }, 500);
            } catch (error) {
                console.error(error);
                loadingText.innerText = "éŒ¯èª¤: " + error.message;
                loader.style.display = 'none';
                btnStart.style.display = 'inline-block';
                btnStart.innerText = "é‡è©¦";
            }
        });

        // è¨­å®šç›¸æ©Ÿ
        async function initCamera() {
            const constraints = {
                audio: false,
                video: {
                    facingMode: 'environment', // å„ªå…ˆä½¿ç”¨å¾Œé¡é ­é‡ç’°å¢ƒå…‰
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;

            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    resolve(video);
                };
            });
        }

        // Canvas å°ºå¯¸è·Ÿè‘— video åŸå§‹è§£æåº¦èµ°ï¼ŒCSS è² è²¬æ‹‰åˆ°å…¨è¢å¹•
        function resizeCanvas() {
            if (!video.videoWidth || !video.videoHeight) return;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        // è¨ˆç®—å¹³å‡äº®åº¦ï¼ˆ0~255ï¼‰
        function computeAverageBrightness(imageData) {
            const data = imageData.data;
            let sum = 0;
            const step = 4 * 8; // é–“éš”å–æ¨£ï¼Œæ¸›å°‘é‹ç®—é‡
            let count = 0;

            for (let i = 0; i < data.length; i += step) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const brightness = (r + g + b) / 3;
                sum += brightness;
                count++;
            }
            return count ? sum / count : 0;
        }

        // æ ¹æ“šäº®åº¦çµ¦å»ºè­°ï¼šè®€æ›¸ / ç©éŠæˆ² / æ”¾é¬† / ç¡è¦º
        function suggestByBrightness(avgBrightness) {
            // å›å‚³æ¨™é¡Œã€æè¿°ã€åº•éƒ¨è‰²å¡Š
            let suggestion = {
                title: "äº®åº¦è³‡è¨Šä¸è¶³",
                detail: "å†è®“é¡é ­å¤šçœ‹ä¸€ä¸‹ç’°å¢ƒï¼Œæˆ–ç¨å¾®ç§»å‹•ä¸€ä¸‹æ‰‹æ©Ÿä½ç½®ã€‚",
                color: "rgba(148, 163, 184, 0.40)" // ç°è‰²
            };

            if (avgBrightness >= 190) {
                suggestion.title = "è¶…é©åˆè®€æ›¸ / å°ˆå¿ƒå·¥ä½œ";
                suggestion.detail = "ç’°å¢ƒéå¸¸æ˜äº®ï¼Œå¾ˆé©åˆè®€æ›¸ã€å¯«ä½œæ¥­ã€å¯«ç¨‹å¼ã€‚æ³¨æ„è¢å¹•ä¸è¦å¤ªåˆºçœ¼å°±å¥½ã€‚";
                suggestion.color = "rgba(74, 222, 128, 0.28)"; // ç¶ 
            } else if (avgBrightness >= 150 && avgBrightness < 190) {
                suggestion.title = "é©åˆèªçœŸåšäº‹æˆ–ä¸Šèª²";
                suggestion.detail = "å…‰ç·šå……è¶³ä½†ä¸åˆºçœ¼ï¼Œå¾ˆé©åˆä¸Šèª²ã€åšå ±å‘Šã€æ•´ç†ç­†è¨˜ã€‚";
                suggestion.color = "rgba(52, 211, 153, 0.28)"; // é’ç¶ 
            } else if (avgBrightness >= 120 && avgBrightness < 150) {
                suggestion.title = "å¾ˆé©åˆç©éŠæˆ² / çœ‹å½±ç‰‡";
                suggestion.detail = "äº®åº¦åä¸­ç­‰ï¼Œè¢å¹•ä¸æœƒå¤ªäº®ä¹Ÿä¸æœƒå¤ªæš—ï¼Œç•¶ä½œå¨›æ¨‚æ™‚é–“å‰›å‰›å¥½ã€‚";
                suggestion.color = "rgba(56, 189, 248, 0.28)"; // æ·ºè—
            } else if (avgBrightness >= 80 && avgBrightness < 120) {
                suggestion.title = "å¾®æš—ç’°å¢ƒ Â· æ¯”è¼ƒé©åˆæ”¾é¬†";
                suggestion.detail = "é€™ç¨®äº®åº¦è®€æ›¸å®¹æ˜“æƒ³ç¡ï¼Œé©åˆè½éŸ³æ¨‚ã€æ»‘æ‰‹æ©Ÿã€è·Ÿæœ‹å‹èŠå¤©ã€‚";
                suggestion.color = "rgba(251, 191, 36, 0.28)"; // é»ƒ
            } else if (avgBrightness >= 40 && avgBrightness < 80) {
                suggestion.title = "åæš— Â· å¾ˆé©åˆæº–å‚™ç¡è¦º";
                suggestion.detail = "äº®åº¦å·²ç¶“è »ä½äº†ï¼Œå¾ˆé©åˆæ”¶å·¥ä¼‘æ¯ã€‚å¦‚æœé‚„è¦çœ‹è¢å¹•ï¼Œå»ºè­°èª¿ä½äº®åº¦ã€‚";
                suggestion.color = "rgba(96, 165, 250, 0.30)"; // æ·±è—
            } else {
                suggestion.title = "å¹¾ä¹å…¨æš— Â· ç¡è¦ºæ™‚é–“åˆ°";
                suggestion.detail = "é€™å€‹äº®åº¦æ»‘æ‰‹æ©ŸçœŸçš„è¶…å‚·çœ¼ï¼Œå»ºè­°ç›´æ¥æ”¾ä¸‹æ‰‹æ©Ÿå¥½å¥½ç¡ä¸€è¦ºã€‚";
                suggestion.color = "rgba(15, 23, 42, 0.80)"; // å¾ˆæ·±
            }

            return suggestion;
        }

        // äº®åº¦åµæ¸¬ä¸» loop
        let lastUpdateTime = 0;
        function brightnessLoop(timestamp) {
            if (!isRunning) return;
            if (!video.videoWidth || !video.videoHeight) {
                requestAnimationFrame(brightnessLoop);
                return;
            }

            // æ¯ 200ms æ›´æ–°ä¸€æ¬¡ï¼Œé¿å…å¤ªåƒæ•ˆèƒ½
            if (timestamp - lastUpdateTime > 200) {
                lastUpdateTime = timestamp;

                // æ¸…ç©º overlay canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // è¨­å®š sampleCanvas å°ºå¯¸
                const sampleWidth = 160;
                const sampleHeight = 120;
                sampleCanvas.width = sampleWidth;
                sampleCanvas.height = sampleHeight;

                // æŠŠå½±ç‰‡ç•«åˆ°ã€Œéš±è— canvasã€
                sampleCtx.drawImage(video, 0, 0, sampleWidth, sampleHeight);

                const imageData = sampleCtx.getImageData(0, 0, sampleWidth, sampleHeight);
                const avgBrightness = computeAverageBrightness(imageData);

                // å–å¾—å»ºè­°
                const suggestion = suggestByBrightness(avgBrightness);

                // åœ¨ç•«é¢ä¸‹æ–¹åŠ ä¸€å±¤é€æ˜è‰²å¡Šç•¶æ°›åœå…‰
                ctx.fillStyle = suggestion.color;
                ctx.fillRect(0, canvas.height * 0.7, canvas.width, canvas.height * 0.3);

                // æ›´æ–° UI æ–‡æ¡ˆ
                suggestTitle.innerText = suggestion.title;
                suggestDetail.innerText = suggestion.detail;
                suggestLight.innerText = `å¹³å‡äº®åº¦ï¼šç´„ ${avgBrightness.toFixed(0)}ï¼ˆ0 æš— ~ 255 äº®ï¼‰`;

                // æ›´æ–°ä¸Šæ–¹ç‹€æ…‹åˆ—
                let levelText = "åµæ¸¬åˆ°çš„å…‰ç·šï¼š";
                if (avgBrightness >= 190) levelText += "è¶…äº® âœ… é©åˆè®€æ›¸";
                else if (avgBrightness >= 150) levelText += "æ˜äº® âœ… é©åˆå·¥ä½œ";
                else if (avgBrightness >= 120) levelText += "ä¸­ç­‰ âœ… é©åˆå¨›æ¨‚";
                else if (avgBrightness >= 80) levelText += "åæš— ğŸŒ™ æ¯”è¼ƒæ”¾é¬†";
                else levelText += "å¾ˆæš— ğŸŒ™ é©åˆç¡è¦º";

                statusText.innerText = levelText + " Â· On-Device é‹ç®—ä¸­";
            }

            requestAnimationFrame(brightnessLoop);
        }
    </script>
</body>
</html>
