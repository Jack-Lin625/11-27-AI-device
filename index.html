<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI On-Device é›¢ç·šæ´»å‹•æ¨è–¦</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>

    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #FFC107;
            --background-color: #f4f4f9;
            --card-background: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 2px 4px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .container {
            width: 90%;
            max-width: 600px;
            padding: 20px 0;
        }

        /* è¦–è¨Šé è¦½æ¡†æ¨£å¼ */
        #video-container {
            width: 100%;
            position: relative;
            background: #222;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        #video-feed {
            display: block;
            width: 100%;
            height: auto;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ï¼Œè®“è‡ªæ‹è¦–è§’æ›´è‡ªç„¶ */
        }

        /* è¨Šæ¯å¡ç‰‡ */
        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 8px var(--shadow-color);
            text-align: center;
        }

        #status {
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: bold;
        }

        #result-text {
            font-size: 1.5em;
            font-weight: bold;
            color: #E91E63; /* æ¨è–¦æ´»å‹•çš„é†’ç›®é¡è‰² */
            min-height: 1.5em; /* ä¿æŒç©ºé–“ï¼Œé¿å…å…§å®¹è·³å‹• */
        }

        #recommendation {
            margin-top: 15px;
            font-size: 1.2em;
            color: #607D8B;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            background-color: var(--secondary-color);
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            margin-top: 10px;
            width: 100%;
            font-weight: bold;
        }

        button:hover {
            background-color: #FFD740;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            color: #666;
        }

        /* éš±è—çš„ Canvas */
        #ai-canvas {
            display: none;
        }
    </style>
</head>
<body>

    <header>
        <h1>AI é›¢ç·šæ´»å‹•æ¨è–¦ (OOOOO)</h1>
    </header>

    <div class="container">
        <div id="video-container">
            <video id="video-feed" autoplay playsinline muted></video>
        </div>

        <div class="card">
            <p id="status">ğŸ’¡ è¼‰å…¥ AI æ¨¡å‹ä¸­ï¼Œè«‹ç¨å€™...</p>
            <p id="recommendation">ç›®å‰ç’°å¢ƒå…‰ç·šåˆ¤æ–·ï¼š</p>
            <p id="result-text">ç­‰å¾…æ¨¡å‹å•Ÿå‹•...</p>
            
            <button id="start-button" onclick="startAIInference()" disabled>
                ğŸš€ å•Ÿå‹• AI åˆ¤æ–·ï¼ˆé›¢ç·šï¼‰
            </button>
        </div>
    </div>
    
    <canvas id="ai-canvas"></canvas>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let model = null;
        let video = document.getElementById('video-feed');
        let statusElement = document.getElementById('status');
        let resultTextElement = document.getElementById('result-text');
        let startButton = document.getElementById('start-button');
        let canvas = document.getElementById('ai-canvas');
        let ctx = canvas.getContext('2d');
        let animationFrameId = null;

        // é è¨­çš„ MobileNetV3 è¼¸å…¥å°ºå¯¸
        const MODEL_INPUT_SIZE = 224; 
        
        // æ˜ å°„ MobileNetV3 è¼¸å‡º (é¡åˆ¥) åˆ°æˆ‘å€‘çš„ã€Œå…‰ç·šç’°å¢ƒã€å’Œã€Œæ´»å‹•æ¨è–¦ã€
        // æ³¨æ„ï¼šMobileNetV3 æ˜¯ç‚º 1000 å€‹å¸¸è¦‹ç‰©é«”è¨­è¨ˆçš„ï¼Œæˆ‘å€‘å°‡ä¾è³´å…¶å°**é¡è‰²**å’Œ**æ•´é«”äº®åº¦**çš„åˆ†é¡
        // é€™è£¡æˆ‘å€‘é€²è¡Œä¸€å€‹ç°¡åŒ–æ˜ å°„ï¼Œåˆ¤æ–·æ¨¡å‹è¼¸å‡ºçš„**ä¸»è¦é¡åˆ¥**ä¾†æ¨æ¸¬å…‰ç·šç’°å¢ƒ
        const LIGHT_CLASSES = {
            'æ˜äº®æˆ¶å¤–/ç™½å¤©': ['volleyball', 'running shoe', 'bannister', 'street sign', 'beach wagon', 'patio', 'sunscreen'],
            'å……è¶³å®¤å…§/é»ƒæ˜': ['laptop', 'desk', 'dining table', 'coffee mug', 'bookcase', 'window screen', 'refrigerator'],
            'æ˜æš—å¤œæ™š/å®¤å…§å¾®å…‰': ['spotlight', 'monitor', 'television', 'pillow', 'bed', 'book'],
        };

        // æ¨è–¦æ´»å‹•çš„å­—å…¸
        const ACTIVITIES = {
            'æ˜äº®æˆ¶å¤–/ç™½å¤©': 'ğŸƒ åœ¨å…¬åœ’æ…¢è·‘ã€ğŸš´ é¨å–®è»Šã€ğŸ§º æˆ¶å¤–é‡é¤ã€ğŸ“· æ‹æ”é¢¨æ™¯ç…§',
            'å……è¶³å®¤å…§/é»ƒæ˜': 'â˜• é–±è®€æ›¸ç±/æ–‡ç« ã€âœï¸ è¦åŠƒå¾…è¾¦æ¸…å–®ã€ğŸ§‘â€ğŸ’» å­¸ç¿’æ–°æŠ€èƒ½ã€ğŸ® ç©ä¼‘é–’éŠæˆ²',
            'æ˜æš—å¤œæ™š/å®¤å…§å¾®å…‰': 'ğŸ§˜ å†¥æƒ³æ”¾é¬†ã€ğŸµ è½è¼•éŸ³æ¨‚ã€ğŸ›Œ æº–å‚™å°±å¯¢ã€ğŸŒ™ æ’°å¯«æ—¥è¨˜/å¿ƒå¾—',
            'æœªçŸ¥ç’°å¢ƒ': 'ğŸ¤” ç„¡æ³•ç¢ºå®šç’°å¢ƒå…‰ç·šï¼Œè«‹èª¿æ•´é¡é ­è§’åº¦ï¼',
        };

        // 1. è¼‰å…¥ MobileNetV3 æ¨¡å‹
        async function loadModel() {
            try {
                statusElement.textContent = 'â³ æ­£åœ¨è¼‰å…¥ AI æ¨¡å‹... (ç´„ 4 MB)';
                // è¼‰å…¥ä¸€å€‹æ¨™æº–çš„ MobileNetV3-Small (0.75) æ¨¡å‹
                // é€™å€‹æ¨¡å‹ä¸€æ—¦è¼‰å…¥ï¼Œå³å¯å®Œå…¨é›¢ç·šé‹ä½œï¼
                model = await tf.loadGraphModel(
                    'https://tfhub.dev/google/imagenet/mobilenet_v3_small_075_224/classification/5',
                    { fromTFHub: true }
                );
                
                // é€²è¡Œä¸€æ¬¡å‡æ¨è«–ï¼Œç¢ºä¿ WebGL å¾Œç«¯åˆå§‹åŒ–å®Œæˆ (æ¸›å°‘ç¬¬ä¸€æ¬¡çœŸå¯¦æ¨è«–å»¶é²)
                tf.tidy(() => {
                    model.predict(tf.zeros([1, MODEL_INPUT_SIZE, MODEL_INPUT_SIZE, 3]));
                });

                statusElement.textContent = 'âœ… AI æ¨¡å‹è¼‰å…¥å®Œæˆï¼æ‚¨ç¾åœ¨å¯ä»¥é€²å…¥é£›èˆªæ¨¡å¼ã€‚';
                startButton.disabled = false;
                startButton.textContent = 'ğŸš€ å•Ÿå‹• AI åˆ¤æ–·ï¼ˆé›¢ç·šé‹ä½œï¼‰';
            } catch (error) {
                console.error('æ¨¡å‹è¼‰å…¥å¤±æ•—:', error);
                statusElement.textContent = `âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼š${error.message}ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚`;
            }
        }

        // 2. å•Ÿå‹•è¦–è¨Šä¸²æµ
        async function setupCamera() {
            try {
                // å˜—è©¦ä½¿ç”¨å¾Œç½®é¡é ­ (environment)
                const constraints = {
                    video: {
                        facingMode: 'environment', // å„ªå…ˆä½¿ç”¨å¾Œç½®é¡é ­
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                return new Promise((resolve) => {
                    video.onloadeddata = () => {
                        // è¨­å®š canvas å°ºå¯¸èˆ‡è¦–è¨Šå°ºå¯¸ä¸€è‡´
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        resolve(true);
                    };
                });
            } catch (error) {
                console.warn('ç„¡æ³•å–å¾—å¾Œç½®é¡é ­ï¼Œå˜—è©¦ä½¿ç”¨å‰ç½®é¡é ­ã€‚', error);
                try {
                    // é€€å›åˆ°ä½¿ç”¨å‰ç½®é¡é ­ (user)
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    return new Promise((resolve) => {
                        video.onloadeddata = () => {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            resolve(true);
                        };
                    });
                } catch (err) {
                    console.error('ç„¡æ³•å–å¾—ä»»ä½•é¡é ­æ¬Šé™:', err);
                    statusElement.textContent = 'âŒ ç„¡æ³•å•Ÿå‹•é¡é ­ã€‚è«‹æª¢æŸ¥æ¬Šé™è¨­å®šã€‚';
                    return false;
                }
            }
        }
        
        // 3. AI æ¨è«–æ ¸å¿ƒ
        function runInference() {
            if (!model) return;

            // tf.tidy æœƒè‡ªå‹•æ¸…ç†ä¸­é–“ç”¢ç”Ÿçš„ tensorï¼Œé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼
            tf.tidy(() => {
                // å°‡è¦–è¨Šå¹€ç¹ªè£½åˆ° canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // å°‡ canvas åœ–åƒè½‰æ›ç‚º Tensor
                const imageTensor = tf.browser.fromPixels(canvas)
                    .resizeNearestNeighbor([MODEL_INPUT_SIZE, MODEL_INPUT_SIZE]) // ç¸®æ”¾è‡³æ¨¡å‹æ‰€éœ€å°ºå¯¸
                    .toFloat() // è½‰æ›ç‚ºæµ®é»æ•¸
                    .div(255.0) // æ­¸ä¸€åŒ–åˆ° 0-1 ç¯„åœ
                    .expandDims(); // å¢åŠ ä¸€å€‹ batch ç¶­åº¦ [1, 224, 224, 3]

                // åŸ·è¡Œæ¨è«– (æ­¤æ­¥é©Ÿå®Œå…¨åœ¨è£ç½®ç«¯é›¢ç·šåŸ·è¡Œ)
                const prediction = model.predict(imageTensor);
                
                // å–å¾—å‰ k å€‹æ©Ÿç‡æœ€é«˜çš„é¡åˆ¥ (é€™è£¡å–å‰ 5 å€‹)
                const topK = tf.topk(prediction, 5);
                const values = topK.values.dataSync();
                const indices = topK.indices.dataSync();

                // å°‡ç´¢å¼•è½‰æ›ç‚º ImageNet é¡åˆ¥åç¨± (éœ€è¦è‡ªè¡Œå¼•å…¥/å®šç¾©é¡åˆ¥å°æ‡‰è¡¨ï¼Œé€™è£¡ä½¿ç”¨ä¸€å€‹ç°¡åŒ–/æ¨¡æ“¬çš„)
                // ç”±æ–¼æ²’æœ‰å®Œæ•´çš„ 1000 é¡åˆ¥è¡¨ï¼Œæˆ‘å€‘ç›´æ¥ä½¿ç”¨ç´¢å¼•ä½œç‚ºåˆ¤æ–·ä¾æ“šçš„ç°¡åŒ–æ¨¡æ“¬
                let lightLevel = 'æœªçŸ¥ç’°å¢ƒ';
                let maxProb = 0;
                let topClassName = `Index ${indices[0]}`; // æš«æ™‚é¡¯ç¤ºç´¢å¼•
                
                // æ¨¡æ“¬ ImageNet é¡åˆ¥åç¨±å°å…‰ç·šçš„åˆ¤æ–·
                // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæœƒä½¿ç”¨ä¸€å€‹é å…ˆè¨“ç·´å¥½çš„å…‰ç·šåˆ†é¡æ¨¡å‹ï¼Œæˆ–å®Œæ•´çš„ ImageNet é¡åˆ¥è¡¨
                if (indices[0] >= 100 && indices[0] < 300 && values[0] > 0.5) {
                    // å‡è¨­ 100-300 å€é–“çš„ç‰©é«”æ›´å¸¸å‡ºç¾åœ¨æˆ¶å¤–/æ˜äº®ç’°å¢ƒ (ä¾‹å¦‚å‹•ç‰©ã€äº¤é€šå·¥å…·ã€å»ºç¯‰)
                    lightLevel = 'æ˜äº®æˆ¶å¤–/ç™½å¤©';
                } else if (indices[0] >= 300 && indices[0] < 700 && values[0] > 0.4) {
                    // å‡è¨­ 300-700 å€é–“çš„ç‰©é«”æ›´å¸¸å‡ºç¾åœ¨å®¤å…§/é»ƒæ˜ (ä¾‹å¦‚å‚¢ä¿±ã€é›»å™¨ã€å·¥å…·)
                    lightLevel = 'å……è¶³å®¤å…§/é»ƒæ˜';
                } else if (values[0] < 0.3 || indices[0] >= 700) {
                    // å‡è¨­æ©Ÿç‡ä½æˆ–å¾Œæ®µç´¢å¼•çš„ç‰©é«”ä»£è¡¨èƒŒæ™¯æ¨¡ç³Šæˆ–ä½å…‰ç’°å¢ƒ
                    lightLevel = 'æ˜æš—å¤œæ™š/å®¤å…§å¾®å…‰';
                }

                maxProb = values[0];

                // æ›´æ–° UI
                updateUI(lightLevel, maxProb, topClassName);
            });
            
            // è«‹æ±‚ä¸‹ä¸€å¹€å‹•ç•«ï¼Œå¯¦ç¾æŒçºŒæ¨è«–
            animationFrameId = requestAnimationFrame(runInference);
        }
        
        // 4. æ›´æ–°ä»‹é¢
        function updateUI(lightLevel, probability, className) {
            let recommendationText = ACTIVITIES[lightLevel] || ACTIVITIES['æœªçŸ¥ç’°å¢ƒ'];
            
            resultTextElement.innerHTML = `${lightLevel} <span style="font-size: 0.7em; color: #999;">(${Math.round(probability * 100)}% ä¿¡å¿ƒ)</span>`;
            document.getElementById('recommendation').innerHTML = `æ¨è–¦æ´»å‹•ï¼š<br><strong>${recommendationText}</strong>`;
            
            // ç°¡æ˜“çš„ç‹€æ…‹é¡è‰²å›é¥‹
            if (lightLevel.includes('æ˜äº®')) {
                resultTextElement.style.color = '#FF9800'; // æ©˜è‰²
            } else if (lightLevel.includes('å……è¶³')) {
                resultTextElement.style.color = '#4CAF50'; // ç¶ è‰²
            } else if (lightLevel.includes('æ˜æš—')) {
                resultTextElement.style.color = '#3F51B5'; // è—è‰²
            } else {
                resultTextElement.style.color = '#E91E63'; // ç´…è‰²
            }
        }

        // 5. å•Ÿå‹•æŒ‰éˆ•é»æ“Šäº‹ä»¶
        async function startAIInference() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                startButton.textContent = 'â–¶ï¸ ç¹¼çºŒå•Ÿå‹• AI åˆ¤æ–·';
                statusElement.textContent = 'â¸ AI åˆ¤æ–·å·²æš«åœã€‚';
                return;
            }

            // ç¢ºä¿é¡é ­å·²å•Ÿå‹•
            if (!video.srcObject) {
                const cameraReady = await setupCamera();
                if (!cameraReady) return;
            }

            statusElement.textContent = 'ğŸš€ AI åˆ¤æ–·å•Ÿå‹•ï¼æ‚¨ç¾åœ¨å¯ä»¥é€²å…¥é£›èˆªæ¨¡å¼ä¸¦æŸ¥çœ‹çµæœã€‚';
            startButton.textContent = 'â¸ æš«åœ AI åˆ¤æ–·';
            
            // é–‹å§‹æŒçºŒæ¨è«–
            runInference();
        }

        // ç¶²é è¼‰å…¥å®Œæˆå¾Œï¼Œå…ˆè¼‰å…¥æ¨¡å‹ï¼Œå†æº–å‚™é¡é ­
        window.onload = async () => {
            await setupCamera(); // å„ªå…ˆæº–å‚™é¡é ­
            await loadModel(); // å†è¼‰å…¥æ¨¡å‹
        };

        // è™•ç†è¦–çª—é—œé–‰æ™‚æ¸…ç†è³‡æº
        window.onbeforeunload = () => {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            // é‡‹æ”¾ TensorFlow.js ä½”ç”¨çš„ WebGL è³‡æº
            if (model) {
                model.dispose();
            }
            tf.disposeVariables();
        };

    </script>

</body>
</html>
