<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI On-Device é›¢ç·šå…‰ç·šåˆ¤æ–·</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>

    <style>
        /* æ²¿ç”¨ä½¿ç”¨è€…æä¾›çš„é…·ç‚« UI æ¨£å¼ */
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* é˜²æ­¢æ²å‹• */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #cam-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
        }

        video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover; /* è®“ç•«é¢å¡«æ»¿æ‰‹æ©Ÿè¢å¹• */
        }
        
        /* éš±è— Canvasï¼Œå› ç‚ºæˆ‘å€‘ä¸å†ç¹ªè£½æ–¹æ¡†ï¼Œåªç”¨æ–¼æŠ“å–å¹€åœ–åƒ */
        #canvas { display: none; }

        /* ä»‹é¢è¦†è“‹å±¤ (UI Overlay) */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        /* ç‹€æ…‹åˆ— */
        .status-bar {
            background: rgba(0, 0, 0, 0.6);
            color: #00ffcc;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(5px);
            align-self: flex-start;
            pointer-events: auto;
            /* æ–°å¢çµæœé¡¯ç¤ºå€åŸŸçš„æ¨£å¼ */
            margin-top: 10px;
            line-height: 1.6;
        }

        #result-display {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 15px;
            align-self: center; /* è®“çµæœé¡¯ç¤ºåœ¨ç•«é¢ä¸­å¤®åº•éƒ¨ */
            margin-bottom: 50px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            pointer-events: auto;
        }

        #light-level {
            font-size: 1.8em;
            font-weight: bold;
            color: #FFC107; /* é è¨­é¡è‰² */
            margin-bottom: 5px;
        }

        #activity-recommendation {
            font-size: 1.1em;
            color: #B3E5FC;
        }

        /* å•Ÿå‹•æŒ‰éˆ• / è¼‰å…¥ç•«é¢ */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
        }

        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,122,255,0.4);
            transition: transform 0.2s;
        }

        button:active { transform: scale(0.95); }

        button:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00ffcc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="cam-container">
        <video id="video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="ui-layer">
        <div class="status-bar" id="status">ç­‰å¾…å•Ÿå‹•...</div>
        
        <div id="result-display">
            <div id="light-level">å…‰ç·šç­‰ç´š</div>
            <div id="activity-recommendation">æ¨è–¦æ´»å‹•å°‡é¡¯ç¤ºåœ¨é€™è£¡</div>
        </div>
    </div>

    <div id="start-screen">
        <div class="loader" id="loader"></div>
        <h2 id="loading-text">æº–å‚™è¼‰å…¥ AI æ¨¡å‹</h2>
        <p style="font-size: 0.9em; color: #aaa; margin: 0 20px;">
            æ­¤æ‡‰ç”¨ä½¿ç”¨ MobileNetV3 é€²è¡Œé›¢ç·šå…‰ç·šåˆ¤æ–·ã€‚<br>æ¨¡å‹è¼‰å…¥å¾Œï¼Œè«‹åˆ‡æ›è‡³**é£›èˆªæ¨¡å¼**ä»¥æ¸¬è©¦é›¢ç·šæ¨è«–ã€‚
        </p>
        <button id="btn-start" disabled>é–‹å§‹è¾¨è­˜ (è¼‰å…¥ä¸­)</button>
    </div>

    <script>
        // DOM å…ƒç´ 
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const btnStart = document.getElementById('btn-start');
        const statusText = document.getElementById('status');
        const startScreen = document.getElementById('start-screen');
        const loader = document.getElementById('loader');
        const loadingText = document.getElementById('loading-text');
        const lightLevelElement = document.getElementById('light-level');
        const recommendationElement = document.getElementById('activity-recommendation');

        let model = undefined;
        let animationFrameId = null;
        
        // MobileNetV3 æ¨¡å‹åƒæ•¸
        const MODEL_INPUT_SIZE = 224; 
        
        // æ´»å‹•æ¨è–¦å­—å…¸ (æ ¹æ“šå…‰ç·šç’°å¢ƒ)
        const ACTIVITIES = {
            'æ˜äº®æˆ¶å¤–/é«˜å…‰': {
                emoji: 'â˜€ï¸',
                level: 'æ˜äº®æˆ¶å¤–/é«˜å…‰',
                recommend: 'æ…¢è·‘ã€é¨å–®è»Šã€æˆ¶å¤–é‡é¤ã€æ‹æ”é¢¨æ™¯ç…§',
                color: '#FFD700'
            },
            'å……è¶³å®¤å…§/ä¸­å…‰': {
                emoji: 'ğŸ’¡',
                level: 'å……è¶³å®¤å…§/ä¸­å…‰',
                recommend: 'é–±è®€æ›¸ç±ã€è¦åŠƒæ¸…å–®ã€å­¸ç¿’æ–°æŠ€èƒ½ã€é€²è¡Œè¦–è¨Šæœƒè­°',
                color: '#00ffcc'
            },
            'æ˜æš—å¤œæ™š/ä½å…‰': {
                emoji: 'ğŸŒ™',
                level: 'æ˜æš—å¤œæ™š/ä½å…‰',
                recommend: 'å†¥æƒ³æ”¾é¬†ã€è½è¼•éŸ³æ¨‚ã€æ’°å¯«æ—¥è¨˜ã€æº–å‚™å°±å¯¢',
                color: '#8A2BE2'
            },
            'æœªçŸ¥ç’°å¢ƒ': {
                emoji: 'ğŸ¤”',
                level: 'ç„¡æ³•åˆ¤æ–·',
                recommend: 'è«‹èª¿æ•´é¡é ­è§’åº¦ï¼Œå°æº–ç’°å¢ƒå…‰ç·š',
                color: '#E91E63'
            }
        };

        // 1. åˆå§‹åŒ–ï¼šè¼‰å…¥æ¨¡å‹ä¸¦è¨­å®šæŒ‰éˆ•
        window.onload = async () => {
            btnStart.addEventListener('click', startAIInference);
            await loadModelAndSetupCamera();
        }

        // 2. è¼‰å…¥æ¨¡å‹å’Œå•Ÿå‹•ç›¸æ©Ÿ
        async function loadModelAndSetupCamera() {
            loadingText.innerText = "æ­£åœ¨è¼‰å…¥ MobileNetV3 æ¨¡å‹ (ç´„ 4 MB)...";
            loader.style.display = 'block';

            try {
                // A. è¼‰å…¥ MobileNetV3 åˆ†é¡æ¨¡å‹
                model = await tf.loadGraphModel(
                    'https://tfhub.dev/google/imagenet/mobilenet_v3_small_075_224/classification/5',
                    { fromTFHub: true }
                );
                
                // é€²è¡Œä¸€æ¬¡å‡æ¨è«–ï¼Œé ç†± AI æ ¸å¿ƒ
                tf.tidy(() => {
                    model.predict(tf.zeros([1, MODEL_INPUT_SIZE, MODEL_INPUT_SIZE, 3]));
                });
                
                loadingText.innerText = "æ¨¡å‹è¼‰å…¥å®Œæˆï¼æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...";
                
                // B. å•Ÿå‹•ç›¸æ©Ÿ
                await setupCamera();
                
                loadingText.innerText = "ç›¸æ©Ÿå°±ç·’ï¼AI å·²æº–å‚™å¥½é›¢ç·šæ¨è«–ã€‚";
                btnStart.disabled = false;
                btnStart.innerText = "ğŸš€ å•Ÿå‹• AI åˆ¤æ–· (å¯é›¢ç·š)";

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                loadingText.innerText = `âŒ éŒ¯èª¤: ${error.message}ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚`;
                loader.style.display = 'none';
            }
        }

        // 3. è¨­å®šç›¸æ©Ÿ
        async function setupCamera() {
            const constraints = {
                audio: false,
                video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;

            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    resizeCanvas();
                    window.addEventListener('resize', resizeCanvas);
                    resolve(true);
                };
            });
        }

        // 4. èª¿æ•´ Canvas å°ºå¯¸
        function resizeCanvas() {
            // å°‡ Canvas è¨­ç‚º Video çš„å¯¦éš›è§£æåº¦
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        // 5. å•Ÿå‹• AI æ¨è«–
        function startAIInference() {
            if (animationFrameId) {
                // å¦‚æœå·²ç¶“åœ¨é‹è¡Œï¼Œå‰‡æš«åœ
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                btnStart.textContent = 'â–¶ï¸ ç¹¼çºŒåˆ¤æ–·';
                statusText.textContent = 'â¸ AI åˆ¤æ–·å·²æš«åœã€‚';
                return;
            }

            // éš±è—å•Ÿå‹•ç•«é¢ï¼Œé–‹å§‹å¯¦æ™‚æ¨è«–
            startScreen.style.display = 'none';
            statusText.textContent = 'ğŸš€ AI é‹ä½œä¸­ - On Device / é›¢ç·šæ¨¡å¼';
            btnStart.textContent = 'â¸ æš«åœåˆ¤æ–·';

            predictLoop();
        }

        // 6. é æ¸¬å¾ªç’° (Loop)
        async function predictLoop() {
            if (!model || video.readyState < 2) {
                animationFrameId = requestAnimationFrame(predictLoop);
                return;
            }

            // tf.tidy è‡ªå‹•æ¸…ç† Tensor è³‡æºï¼Œç¢ºä¿é«˜æ•ˆèƒ½
            tf.tidy(() => {
                // A. å½±åƒè™•ç†
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageTensor = tf.browser.fromPixels(canvas)
                    .resizeNearestNeighbor([MODEL_INPUT_SIZE, MODEL_INPUT_SIZE])
                    .toFloat()
                    .div(255.0) // æ­¸ä¸€åŒ–
                    .expandDims();

                // B. åŸ·è¡Œæ¨è«– (å®Œå…¨é›¢ç·š)
                const prediction = model.predict(imageTensor);
                
                // C. å–å¾—æ¨è«–çµæœ
                const topK = tf.topk(prediction, 1);
                const values = topK.values.dataSync();
                const indices = topK.indices.dataSync();

                const maxProb = values[0];
                const topIndex = indices[0];

                let lightResult;

                // D. æ ¹æ“š ImageNet ç´¢å¼•æ¨¡æ“¬å…‰ç·šåˆ¤æ–·
                // é€™æ˜¯å°é€šç”¨åˆ†é¡æ¨¡å‹çš„ä¸€ç¨®å‰µæ„æ‡‰ç”¨ï¼š
                if (maxProb < 0.3) {
                     // ä¿¡å¿ƒåº¦å¤ªä½ï¼Œå¯èƒ½æ˜¯ç•«é¢å¤ªæš—æˆ–å¤ªé›œäº‚
                    lightResult = ACTIVITIES['æœªçŸ¥ç’°å¢ƒ'];
                } else if (topIndex >= 100 && topIndex < 300) {
                    // å‡è¨­ 100-300 å€é–“çš„ç‰©é«”æ›´å¸¸å‡ºç¾åœ¨æˆ¶å¤–/æ˜äº®ç’°å¢ƒ (å¦‚å‹•ç‰©ã€äº¤é€šå·¥å…·)
                    lightResult = ACTIVITIES['æ˜äº®æˆ¶å¤–/é«˜å…‰'];
                } else if (topIndex >= 300 && topIndex < 700) {
                    // å‡è¨­ 300-700 å€é–“çš„ç‰©é«”æ›´å¸¸å‡ºç¾åœ¨å®¤å…§/ä¸­å…‰ç’°å¢ƒ (å¦‚å‚¢ä¿±ã€é›»å™¨)
                    lightResult = ACTIVITIES['å……è¶³å®¤å…§/ä¸­å…‰'];
                } else {
                    // 700 ä»¥å¾Œçš„ç´¢å¼•æˆ–ä½ä¿¡å¿ƒåº¦æ¨æ¸¬ç‚ºä½å…‰
                    lightResult = ACTIVITIES['æ˜æš—å¤œæ™š/ä½å…‰'];
                }

                // E. æ›´æ–° UI
                updateUI(lightResult, maxProb);
            });
            
            animationFrameId = requestAnimationFrame(predictLoop);
        }

        // 7. æ›´æ–°ä»‹é¢
        function updateUI(result, probability) {
            lightLevelElement.textContent = `${result.emoji} ${result.level}`;
            lightLevelElement.style.color = result.color;
            
            recommendationElement.innerHTML = 
                `<strong>æ¨è–¦æ´»å‹•:</strong> ${result.recommend} 
                 <br><span style="font-size: 0.8em; opacity: 0.7;"> (ä¿¡å¿ƒåº¦: ${Math.round(probability * 100)}%) </span>`;
        }

        // 8. è³‡æºæ¸…ç†
        window.onbeforeunload = () => {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            if (model) {
                model.dispose();
            }
            tf.disposeVariables();
        };

    </script>
</body>
</html>
